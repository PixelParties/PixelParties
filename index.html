<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Pixel Parties</title>
    
    <!-- Preload the custom font for better performance -->
    <link rel="preload" href="./Fonts/Pixel Intv.otf" as="font" type="font/otf" crossorigin>
    
    <!-- Font face declaration -->
    <style>
        @font-face {
            font-family: 'Pixel Intv';
            src: url('./Fonts/Pixel Intv.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        
        /* Global font application */
        * {
            font-family: 'Pixel Intv', 'Courier New', monospace, sans-serif !important;
        }
        
        /* Font loading states */
        .fonts-loading * {
            visibility: hidden;
        }
        
        .fonts-loading .loading-spinner,
        .fonts-loading .selection-spinner,
        .fonts-loading .waiting-spinner {
            visibility: visible;
        }
        
        .fonts-loaded * {
            visibility: visible;
            transition: opacity 0.3s ease;
        }
        
        /* Ensure good font rendering */
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }
    </style>
    
    <link rel="stylesheet" href="main.css">
</head>
<body class="fonts-loading">
    <div class="container">
        <h1>Project Pixel Parties</h1>
        <div class="game-subtitle">🃏 Pixel Art Auto Battler 🎯</div>
        
        <div id="menu" class="menu-buttons">
            <div class="input-section">
                <label for="usernameInput">👤 Username:</label>
                <input type="text" id="usernameInput" class="text-input" placeholder="Enter your username" maxlength="20" value="Player">
            </div>
            
            <div id="passwordSection" class="input-section password-section hidden">
                <label for="passwordInput">🔒 Room Password (Optional):</label>
                <input type="password" id="passwordInput" class="text-input" placeholder="Leave empty for public room" maxlength="50">
                <div class="password-hint">Leave empty to create a public room, or set a password for private access.</div>
            </div>
            
            <button id="startBtn" class="btn btn-primary">🎯 Create Party</button>
            <button id="confirmCreateBtn" class="btn btn-primary hidden">🎮 Create Game</button>
            <button id="cancelCreateBtn" class="btn btn-secondary hidden">❌ Cancel</button>
            <button id="joinBtn" class="btn btn-secondary">⚔️ Browse Battles</button>
            <button id="leaveBtn" class="btn btn-danger hidden">🚪 Leave Party</button>
        </div>

        <!-- Room Browser Interface -->
        <div id="roomBrowser" class="room-browser hidden">
            <div class="browser-header">
                <h2>🎮 Available Battle Rooms</h2>
                <button id="backToMenuBtn" class="btn-back">← Back to Menu</button>
            </div>
            <div id="roomsList" class="rooms-list">
                <div class="loading-rooms">🔍 Searching for battles...</div>
            </div>
            <div class="browser-footer">
                <button id="refreshRoomsBtn" class="btn btn-secondary">🔄 Refresh</button>
            </div>
        </div>

        <div id="status" class="status hidden"></div>
        <div id="roomInfo" class="room-info hidden"></div>
        <div id="playersList" class="players-list hidden"></div>
        <div id="connectionDetails" class="connection-details hidden"></div>
    </div>

    <!-- Game Screen - Full Width -->
    <div id="gameScreen" class="game-screen hidden">
        <!-- Hero Selection Area - Will be dynamically populated -->
        <div class="hero-selection-screen">
            <div class="loading-heroes">
                <h2>🎮 Loading Heroes...</h2>
                <div class="loading-spinner"></div>
            </div>
        </div>
        
        <!-- Surrender Button (shown only after character selection) -->
        <button id="surrenderBtn" class="surrender-button hidden">🏳️ Surrender</button>
    </div>

    <!-- Password Prompt Modal -->
    <div id="passwordModal" class="modal-overlay hidden">
        <div class="password-modal">
            <div class="modal-title">🔒 Password Required</div>
            <div class="modal-description">This room is password protected. Please enter the password to join:</div>
            <div id="passwordError" class="password-error hidden">❌ Wrong password! Please try again.</div>
            <div class="input-section">
                <input type="password" id="modalPasswordInput" class="text-input" placeholder="Enter room password" maxlength="50">
            </div>
            <div class="modal-buttons">
                <button id="modalCancelBtn" class="btn-modal secondary">Cancel</button>
                <button id="modalJoinBtn" class="btn-modal primary">Join Room</button>
            </div>
        </div>
    </div>

    <!-- Surrender Confirmation Modal -->
    <div id="surrenderModal" class="modal-overlay hidden">
        <div class="surrender-modal">
            <div class="surrender-title">🏳️ Surrender Battle</div>
            <div class="surrender-description">Do you really want to give up?</div>
            <div class="surrender-buttons">
                <button id="surrenderNoBtn" class="btn-surrender-confirm no">No</button>
                <button id="surrenderYesBtn" class="btn-surrender-confirm yes">Yes</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-database-compat.min.js"></script>

    <!-- Enhanced Font Loading Handler -->
    <script>
        (function() {
            'use strict';
            
            // Font loading is already handled by CSS classes above
            // This script provides additional functionality
            
            function markFontsAsLoaded() {
                document.documentElement.classList.remove('fonts-loading');
                document.documentElement.classList.add('fonts-loaded');
                document.body.classList.remove('fonts-loading');
                document.body.classList.add('fonts-loaded');
                
                // Dispatch custom event
                window.dispatchEvent(new CustomEvent('pixelFontsLoaded'));
                console.log('✅ Pixel Intv font loaded and applied globally');
            }
            
            function checkPixelFontLoaded() {
                if (document.fonts && document.fonts.ready) {
                    document.fonts.ready.then(() => {
                        if (document.fonts.check('16px "Pixel Intv"')) {
                            markFontsAsLoaded();
                        } else {
                            console.warn('⚠️ Pixel Intv font failed to load, using fallback');
                            markFontsAsLoaded();
                        }
                    }).catch(() => {
                        console.warn('⚠️ Font loading API failed, using fallback');
                        markFontsAsLoaded();
                    });
                } else {
                    // Fallback for older browsers
                    const testElement = document.createElement('div');
                    testElement.style.cssText = `
                        font-family: 'Pixel Intv', monospace;
                        font-size: 16px;
                        position: absolute;
                        visibility: hidden;
                        top: -999px;
                        white-space: nowrap;
                    `;
                    testElement.textContent = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
                    document.body.appendChild(testElement);
                    
                    const fallbackWidth = testElement.offsetWidth;
                    testElement.style.fontFamily = 'monospace';
                    const monospaceWidth = testElement.offsetWidth;
                    testElement.style.fontFamily = "'Pixel Intv', monospace";
                    
                    let attempts = 0;
                    const maxAttempts = 50;
                    
                    const checkInterval = setInterval(() => {
                        attempts++;
                        const currentWidth = testElement.offsetWidth;
                        
                        if (currentWidth !== monospaceWidth || attempts >= maxAttempts) {
                            markFontsAsLoaded();
                            if (testElement.parentNode) {
                                document.body.removeChild(testElement);
                            }
                            clearInterval(checkInterval);
                            
                            if (attempts >= maxAttempts) {
                                console.warn('⚠️ Font loading timeout, proceeding with available fonts');
                            }
                        }
                    }, 100);
                }
            }
            
            // Initialize font loading detection
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', checkPixelFontLoaded);
            } else {
                checkPixelFontLoaded();
            }
            
            // Fallback timeout
            setTimeout(() => {
                if (document.body.classList.contains('fonts-loading')) {
                    console.warn('⚠️ Font loading timeout, forcing content display');
                    markFontsAsLoaded();
                }
            }, 3000);
            
            // Global font status checker
            window.isPixelFontLoaded = function() {
                return document.documentElement.classList.contains('fonts-loaded');
            };
            
        })();
    </script>

    <!-- Application Modules -->
    <script type="module" src="main.js"></script>
</body>
</html>